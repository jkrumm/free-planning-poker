# Free Planning Poker - AI Development Guide

## Quick Reference

| Service | Runtime | Framework | Port | CLAUDE.md |
|---------|---------|-----------|------|-----------|
| **Next.js App** | Node 22 | Next.js 16 (Pages Router) | 3001 | This file |
| **WebSocket Server** | Bun | Elysia 1.4 | 3003 | `fpp-server/CLAUDE.md` |
| **Analytics API** | Python 3.12 | FastAPI | 5100 | `fpp-analytics/CLAUDE.md` |
| **Logdy (Logs UI)** | Go | Logdy | 8080 | - |

---

## Skills & Token Efficiency

### Global Skills (from SourceRoot)

This project inherits skills from `/Users/johannes.krumm/SourceRoot/.claude/skills/`:

| Skill | Context | Purpose |
|-------|---------|---------|
| `/commit [ticket]` | main | Smart conventional commits with OpenSpec awareness |
| `/pr [action]` | main | GitHub PR workflow (create, status, merge) |
| `/code-quality` | **fork** | Format, lint, typecheck, test (~70% token savings) |
| `/research <query>` | **fork** | Deep technical research (~80% token savings) |
| `/review` | **fork** | Agnostic code review |
| `/fix-sentry <project> <search>` | main | Debug Sentry errors |

### Project-Specific Skills

| Skill | Context | Purpose |
|-------|---------|---------|
| `/release-fpp [version]` | main | AI-enhanced GitHub releases |

### Token Efficiency Rules

**ALWAYS use forked skills for:**
- Validation ‚Üí `/code-quality` (not `npm run validate` inline)
- Research ‚Üí `/research` (not inline web search)
- Code review ‚Üí `/review` (not reading multiple files)

**ToolSearch for MCP loading:**
```
ToolSearch("select:mcp__sentry__search_issues")  # Load Sentry tool
ToolSearch("select:mcp__context7__query-docs")   # Load Context7 tool
```

---

## No AI Attribution

**CRITICAL:** Do NOT add AI attribution anywhere in this project.

| Location | Rule |
|----------|------|
| **Code comments** | No "Generated by AI", "Claude wrote this", etc. |
| **Commit messages** | No `Co-Authored-By: Claude...` footer |
| **PR descriptions** | No "Created with Claude Code" footer |
| **Documentation** | No "AI-generated" disclaimers |

---

## Multi-Service Architecture

Free Planning Poker runs on three independent services:

1. **Next.js App** (port 3001) - UI, tRPC API, database operations
2. **Bun WebSocket Server** (port 3003) - Real-time room state, in-memory
3. **FastAPI Analytics** (port 5100) - Analytics calculations, read-only
4. **Logdy** (port 8080) - Unified log viewer (local development only)

üìñ **For detailed architecture**, see `ARCHITECTURE.md` and `openspec/config.yaml`

### When to Modify Which Service

**Next.js (this service):**
- UI components, pages, routing
- tRPC API endpoints (non-realtime)
- Database operations via Drizzle
- SEO, analytics tracking, auth

**fpp-server (WebSocket):**
- Real-time room state (votes, users, flip status)
- WebSocket action handlers
- In-memory room state management
- Broadcast logic

**fpp-analytics (FastAPI):**
- Read-only analytics calculations
- Parquet file processing
- Analytics page dashboard endpoints

### Cross-Service Change Patterns

#### Pattern 1: Add New Room Action
1. Define Action type in `fpp-server/src/room.actions.ts`
2. Add handler in `fpp-server/src/message.handler.ts`
3. Update client to send action via `triggerAction()`
4. Update Zustand store to reflect state changes (if new state needed)

#### Pattern 2: Add Database Tracking
1. Add column/table in `src/server/db/schema.ts`
2. Generate migration !HumanInTheLoop!: `npm run db:generate`
3. Update tRPC router to persist data
4. Update analytics if needed (`fpp-analytics/calculations/`)

#### Pattern 3: Add Analytics Metric
1. Update `fpp-analytics/update_readmodel.py` to sync table
2. Create calculation in `fpp-analytics/calculations/`
3. Add endpoint in `fpp-analytics/routers/`
4. Consume from Next.js via tRPC proxy

### Critical Cross-Service Rules

#### State Synchronization
Room state exists in THREE places:
1. **MySQL database** - Persistent, historical (Next.js writes via Drizzle)
2. **Bun server memory** - Authoritative, real-time (fpp-server manages)
3. **Client Zustand store** - Local, synced via WebSocket

**Rule:** Always update authoritative source first, then propagate.

#### Communication Protocols

| From ‚Üí To | Protocol | Use Case | Example |
|-----------|----------|----------|---------|
| Client ‚Üí Next.js | tRPC | Room creation, joining, name changes | `api.room.joinRoom.useMutation()` |
| Client ‚Üí fpp-server | WebSocket | Real-time actions (vote, flip, reset) | `triggerAction({ action: 'selectEstimation' })` |
| fpp-server ‚Üí Next.js | HTTP | Persist vote after flip | `fetch('/api/trpc/room.trackFlip')` |
| Next.js ‚Üí fpp-analytics | None | Analytics runs independently | - |

#### Error Handling Responsibilities

| Service | Error Handling | Sentry Context |
|---------|----------------|----------------|
| Next.js | Sentry breadcrumbs + `captureError()` | component, action, userId, roomId |
| fpp-server | Sentry `captureException()` | roomId, userId, action type |
| fpp-analytics | Sentry `capture_exception()` | endpoint, calculation type |

### Development Workflow Commands

```bash
# Start all services simultaneously
npm run dev:all                           # Next.js + WebSocket + Analytics

# Or start individually:
npm run dev                               # Next.js (port 3001)
cd fpp-server && bun dev                  # WebSocket (port 3003)
cd fpp-analytics && uv run uvicorn main:app --reload  # Analytics (port 3002)

# Code quality (run from root)
npm run pre                               # Format, lint, type-check, build
```

---

## Project Overview

Free Planning Poker is a Next.js application using the **Pages Router** (not App Router). Key technologies:
- **Next.js 16.0.1** with Turbopack
- **React 19.2.0** with stricter linting rules
- **tRPC 11.7.1** for type-safe API layer
- **Bun WebSocket server** for real-time features
- **Zustand 5.0.8** for state management
- **Drizzle ORM 0.44.7** with MySQL
- **Tailwind CSS 4** + **Mantine 8.3.6** for UI

## Build & Development Commands

**IMPORTANT**: Always use `SKIP_ENV_VALIDATION=1` for builds to avoid environment validation failures.

```bash
# Development
npm run dev                              # Start dev server on port 3001 - Only suggest to user
npm run dev:all                          # Start all services (Next.js, fpp-server, analytics) - Only suggest to user

# Building (REQUIRED env var)
SKIP_ENV_VALIDATION=1 npm run build

# Code Quality & Validation
npm run validate                         # Validate all services in parallel
npm run validate:nextjs                  # Validate Next.js only
npm run validate:fpp-server              # Validate fpp-server only
npm run validate:fpp-analytics           # Validate fpp-analytics only

# Next.js specific
npm run lint                             # Run ESLint
npm run lint:fix                         # Auto-fix ESLint issues
npm run type-check                       # TypeScript type checking
npm run format                           # Format with Prettier
npm run pre                              # Run all checks (format, lint, type-check, build)

# fpp-server specific
cd fpp-server && bun run validate        # All checks for fpp-server
cd fpp-server && bun run lint            # ESLint for fpp-server
cd fpp-server && bun run type-check      # TypeScript for fpp-server

# fpp-analytics specific
npm run fpp-analytics:validate           # All checks for fpp-analytics
npm run fpp-analytics:lint               # Ruff lint
npm run fpp-analytics:type-check         # mypy type check

# Database
npm run db:generate                      # Generate Drizzle migrations - Only suggest to user
npm run db:migrate                       # Run migrations - Only suggest to user
npm run db:studio                        # Open Drizzle Studio - Only suggest to user
```

## Logdy Integration

Logdy provides a unified web UI for viewing logs from all services in real-time during local development.

**Web UI:** http://localhost:8080

### Features

- Real-time log streaming from all services (Next.js, fpp-server, fpp-analytics)
- Automatic JSON log parsing (Pino structured logs)
- Filter by service name (`service:free-planning-poker`, `service:fpp-server`, `service:fpp-analytics`)
- Filter by origin port (8081=Next.js, 8082=fpp-server, 8083=fpp-analytics)
- Search across all logs (field-based: e.g., `userId:abc123`, `level:error`, `component:auth`)
- Color-coded log levels (20=debug, 30=info, 40=warn, 50=error, 60=fatal)
- Timeline view with timestamps

### Installation (One-time per Machine)

```bash
brew tap logdyhq/logdy
brew install logdy

# Verify installation
logdy --version
```

### Usage

```bash
# Start all services with Logdy (recommended for multi-service development)
npm run dev:all
# Opens:
# - http://localhost:3001 (Next.js)
# - http://localhost:3003 (fpp-server)
# - http://localhost:5100 (fpp-analytics)
# - http://localhost:8080 (Logdy UI)

# Start individual services without Logdy (simpler for single-service work)
npm run dev              # Next.js only
cd fpp-server && bun dev # fpp-server only
cd fpp-analytics && uv run uvicorn main:app --reload --port 5100 # Analytics only
```

### Logging Architecture

All services use structured JSON logging (Pino format):

| Service | Logger | Format | Output |
|---------|--------|--------|--------|
| **Next.js** | Pino | JSON | stdout |
| **fpp-server** | Pino | JSON | stdout |
| **fpp-analytics** | python-json-logger | JSON (Pino-compatible) | stdout |

**Pino Log Format:**
```json
{
  "level": 30,              // 10=trace, 20=debug, 30=info, 40=warn, 50=error, 60=fatal
  "time": 1704206400000,    // Unix timestamp (ms)
  "msg": "User logged in",
  "service": "free-planning-poker",  // Service identifier
  "userId": "abc123",       // Custom fields
  "component": "auth",
  "action": "login"
}
```

**Benefits:**
- Unified log viewing across all three services
- JSON structure makes logs searchable and filterable
- Production-ready (structured logs work with log aggregation tools)
- Error logs automatically sent to Sentry

**How it works:**
- Logdy runs in **socket mode** listening on ports 8081, 8082, 8083
- Each service pipes logs to its dedicated port via `logdy forward`
- Logs are tagged with `origin.port` for filtering (8081=Next.js, 8082=fpp-server, 8083=fpp-analytics)
- Web UI (port 8080) aggregates and displays all streams in real-time

**Note:** Next.js dev server outputs some plain text logs (e.g., "GET /api/... 200 in 632ms (compile: 4ms)") that cannot be suppressed. These are development-only and won't appear in production (`next start`).

**Logdy Configuration:**
- Config file: `logdy.config.json` (automatically loaded)
- Custom columns: time, level, service, msg, error
- Middleware: Filters debug logs (level < 30) and noisy compile logs
- Error column: Displays `error.message` field in red for easy spotting

### Production Logging

All services output **production-ready JSON logs** to stdout:

**Current setup:**
- Services output structured JSON logs (Pino format)
- All logs include `service` field for filtering
- Logs go to stdout/stderr (captured by Docker/K8s)
- Compatible with any JSON log aggregation tool

**Log correlation:**
- Filter by `service` field: `free-planning-poker`, `fpp-server`, `fpp-analytics`
- Correlate by `userId`, `roomId` across services
- Future: Add `requestId` for distributed tracing

**Note:** Production log aggregation tool (Loki, Datadog, etc.) not yet configured.

## Critical Rules

### üö® Pages Router - NOT App Router
This project uses Next.js **Pages Router**. Do not use App Router patterns:
- ‚ùå No `app/` directory
- ‚ùå No Server Components
- ‚ùå No `async` components
- ‚ùå No `export const metadata`
- ‚úÖ Use `/src/pages` directory
- ‚úÖ Use `getStaticProps`, `getServerSideProps`
- ‚úÖ Import from `next/router` not `next/navigation`
- ‚úÖ Use tRPC for API routes

### üö® Import Alias
Use `fpp/*` for all internal imports:
```typescript
// ‚úÖ Correct
import { api } from 'fpp/utils/api';
import { useRoomStore } from 'fpp/store/room.store';

// ‚ùå Wrong
import { api } from '../../utils/api';
import { useRoomStore } from '../store/room.store';
```

### üö® Environment Variables
- **Client vars**: Must be prefixed with `NEXT_PUBLIC_`
- **Build command**: Always use `SKIP_ENV_VALIDATION=1 npm run build`
- **Environment file**: Use Doppler (not .env) for local development

## ESLint & React 19 Linting

We use **ESLint flat config** (`eslint.config.mjs`) with React 19's strict rules.

### Valid Suppression Patterns

React 19 introduced stricter linting. Some patterns require suppression for **valid use cases**:

#### 1. `react-hooks/set-state-in-effect` - Valid for:
- SSR hydration safety (mount detection)
- Timer initialization
- One-time initialization flags

```tsx
useEffect(() => {
  // eslint-disable-next-line react-hooks/set-state-in-effect -- Valid pattern: SSR hydration safety
  setHasMounted(true);
}, []);
```

#### 2. `react-hooks/error-boundaries` - Valid for:
- Sentry breadcrumb logging (not error handling)
- Component-level logging

#### 3. `react-hooks/purity` - Valid for:
- `Date.now()` in refs for timestamp tracking

#### 4. `react-hooks/immutability` - Valid for:
- Recursive callbacks (self-scheduling timers)

**Format**:
```tsx
// eslint-disable-next-line rule-name -- Brief explanation of why this is valid
```

## Project Structure

```plaintext
free-planning-poker/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/         # React components
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ room/          # Room-related components (main app)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/             # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ pages/             # Next.js Pages Router
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _app.tsx       # App wrapper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _document.tsx  # HTML document
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/           # tRPC API routes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ room/          # Room pages
‚îÇ   ‚îú‚îÄ‚îÄ server/            # Server-side code
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/           # tRPC routers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db/            # Database schema
‚îÇ   ‚îú‚îÄ‚îÄ store/             # Zustand stores
‚îÇ   ‚îú‚îÄ‚îÄ utils/             # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ env.ts             # Environment validation
‚îÇ   ‚îî‚îÄ‚îÄ proxy.ts           # Next.js proxy (rate limiting)
‚îú‚îÄ‚îÄ fpp-server/            # Bun WebSocket server
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ index.ts       # Elysia server entry
‚îÇ       ‚îú‚îÄ‚îÄ room.state.ts  # In-memory room state
‚îÇ       ‚îú‚îÄ‚îÄ room.entity.ts # Room/User classes
‚îÇ       ‚îú‚îÄ‚îÄ room.types.ts  # Shared types
‚îÇ       ‚îú‚îÄ‚îÄ room.actions.ts # WebSocket action types
‚îÇ       ‚îî‚îÄ‚îÄ message.handler.ts # Action handler
‚îî‚îÄ‚îÄ public/                # Static assets
```

## Key Files & Their Purpose

### State Management
- `src/store/room.store.ts` - Real-time room state (users, votes, connection status)
- `src/store/local-storage.store.ts` - Persistent client data (userId, username)

### Core Hooks
- `src/hooks/useWebSocketRoom.ts` - WebSocket connection + action queue system
- `src/hooks/useHeartbeat.ts` - Dual heartbeat (5min client, 30min server)
- `src/hooks/usePresenceTracking.ts` - Tab visibility tracking
- `src/hooks/use-has-mounted.hook.ts` - SSR hydration safety

### Room Components
- `src/components/room/room-wrapper.tsx` - Room initialization & validation
- `src/components/room/room.tsx` - Main room component (900 lines)

### WebSocket Server
- `fpp-server/src/index.ts` - Elysia WebSocket server
- `fpp-server/src/room.state.ts` - In-memory Map<roomId, RoomServer>
- `fpp-server/src/message.handler.ts` - Handle WebSocket actions

### Database
- `src/server/db/schema.ts` - Drizzle schema (rooms, users, votes, estimations)
- `src/server/api/routers/room.router.ts` - Room tRPC endpoints

## Code Style Guidelines

### TypeScript
- Use strict mode
- Prefer type inference over explicit types
- Use `type` for objects, `interface` for extensible contracts
- Use `satisfies` for type narrowing

### React Components
- Functional components with hooks
- Use `type` for component props
- Keep components small and focused
- Extract complex logic into custom hooks

### Zustand Patterns
**Selective subscriptions** - only subscribe to needed state:
```tsx
// ‚úÖ Good - re-renders only when users change
const users = useRoomStore((state) => state.users);

// ‚ùå Bad - re-renders on ANY state change
const roomState = useRoomStore();
```

### Import Order (enforced by Prettier)
1. React imports
2. Next.js imports
3. Third-party libraries
4. Internal imports (using `fpp/*` alias)
5. Types

## Common Patterns

### tRPC Mutations
```typescript
const mutation = api.room.joinRoom.useMutation({
  onSuccess: (data) => { /* handle success */ },
  onError: (error) => {
    captureError(error, { component: 'X', action: 'Y' }, 'high');
  },
});
```

### WebSocket Actions
All WebSocket messages go through `triggerAction()`:
```typescript
triggerAction({
  action: 'selectEstimation',
  userId,
  roomId,
  estimation: '5',
});
```

### Error Handling
Use Sentry with breadcrumbs:
```typescript
addBreadcrumb('User action', 'component', { userId, roomId });
captureError(error, { component: 'ComponentName', action: 'actionName' }, 'high');
```

## Testing & Verification

Before committing:
```bash
npm run pre  # Runs format, lint, type-check, and build
```

## Common Gotchas

### 1. WebSocket vs tRPC
- **tRPC** (HTTP): Room creation, joining, stats, name changes
- **WebSocket**: Real-time state (votes, flips, user presence)

### 2. State Duplication
Room state exists in THREE places:
1. MySQL database (persistent)
2. Bun server memory (real-time, authoritative)
3. Client Zustand store (local, synced via WebSocket)

### 3. nanoid(21) for User IDs
Users are anonymous. Each client generates a 21-character nanoid stored in localStorage.

### 4. Connection Resilience
The app has an **action queue** in `useWebSocketRoom.ts` - actions sent while disconnected are queued and sent on reconnect.

### 5. Build Environment
Local builds require `SKIP_ENV_VALIDATION=1` - environment variables are managed via Doppler.

## Sentry Error Handling Standards

### Import Rule (Enforced by ESLint)
```typescript
// ‚úÖ Correct - use the wrapper
import { captureError, captureMessage, addBreadcrumb } from 'fpp/utils/app-error';

// ‚ùå BANNED - direct Sentry imports
import { captureException, captureMessage } from '@sentry/nextjs';
```

### When to Use captureError

**Capture:**
- System errors (database, server crashes)
- Failed mutations with no fallback
- Authentication failures
- tRPC: INTERNAL_SERVER_ERROR, TIMEOUT, UNKNOWN
- Bugs in validation logic (e.g., unexpected null/undefined)

**Don't Capture:**
- User input validation errors (wrong format, too long, etc.)
- tRPC: BAD_REQUEST, CONFLICT (business logic errors)
- WebSocket 1006 closes (auto-reconnect)
- Expected business logic failures

### Severity Decision Tree

```
Prevents app from working? ‚Üí critical
Blocks user action? ‚Üí high (system errors, auth failures)
Validation/business error? ‚Üí medium (fix the frontend)
Recoverable/handled? ‚Üí medium (network issues, query failures)
Informational? ‚Üí low
```

### tRPC Mutation Pattern

```typescript
mutation.mutate(data, {
  onError: (error) => {
      captureError(error, {
        component: 'ComponentName',
        action: 'actionName',
        extra: { errorCode }
      }, 'high');

    // Always show user feedback
    showErrorNotification(error.message);
  }
});
```

### captureError Usage

```typescript
// Good: Provides context
captureError(error, {
  component: 'UserProfile',
  action: 'updateSettings',
  extra: { userId, settingKey }
}, 'high');

// Bad: No context
captureError(error);

// Good: Capturing user input error to fix frontend validations
if (email.length > 100) {
  captureError('Email too long', { component: 'Form' }, 'medium');
}

// Good: Capturing validation logic bug
try {
  return value.trim().length > 50;
} catch (error) {
  captureError(error, { component: 'Form', action: 'validate' }, 'low');
}
```

### Breadcrumb Guidelines

**Use breadcrumbs for:**
- Navigation events (page changes, route transitions)
- WebSocket lifecycle (connect, disconnect, reconnect)
- Critical user actions (create room, join room, vote)
- State transitions (connection health, heartbeat pings)

**Don't use breadcrumbs for:**
- Every render or effect
- Repeated/frequent events (individual keystrokes, mouse moves)
- Events that don't help debug errors

**Current usage:** 21 files use breadcrumbs - mostly in hooks (WebSocket, heartbeat, connection health) and navigation. This is appropriate for central, high-level operations.

## Error Handling Implementation Guide

This section provides comprehensive patterns for implementing error handling across Next.js API routes and tRPC routers using CustomTRPCError.

### Overview

Free Planning Poker uses **CustomTRPCError** for centralized error capture. All system errors flow through a single capture point in `src/pages/api/trpc/[trpc].ts`, eliminating double-capture bugs and reducing boilerplate.

**Key Files:**
- `src/server/api/custom-error.ts` - CustomTRPCError class and helpers
- `src/pages/api/trpc/[trpc].ts` - Central error handler
- `src/utils/app-error.ts` - Sentry wrapper (used by API routes and frontend)

### Next.js API Routes (Pages Router)

All Next.js API route handlers (`/src/pages/api/*.ts`) must wrap their logic in try-catch blocks:

```typescript
import { type NextApiRequest, type NextApiResponse } from '@trpc/server/adapters/next';
import { captureError } from 'fpp/utils/app-error';

const ApiHandler = async (req: NextApiRequest, res: NextApiResponse) => {
  try {
    // Validate request method
    if (req.method !== 'POST') {
      throw new MethodNotAllowedError('Only POST requests allowed');
    }

    // Parse and validate input
    const { userId, data } = req.body;
    validateInput(userId, data);

    // Perform database operations
    await db.insert(table).values({ userId, data });

    // Return success response
    return res.status(200).json({ success: true });
  } catch (error) {
    // Capture error with context
    captureError(
      error instanceof Error ? error : new Error('Operation failed'),
      {
        component: 'api-route-name',
        action: 'handlerName',
        extra: {
          method: req.method ?? 'unknown',
          hasBody: !!req.body,
          // Add relevant context (avoid sensitive data)
        },
      },
      'high', // Adjust severity based on impact
    );

    // Return error response
    return res.status(500).json({
      error: 'Internal server error',
      // Return safe error details if needed
    });
  }
};

export default ApiHandler;
```

**Key Points:**
- Wrap entire handler function in try-catch
- Capture errors with component/action context using `captureError`
- Return HTTP 500 with safe error message
- Use 'high' severity for API failures (blocks user action)

### tRPC Router Error Handling (CustomTRPCError)

**IMPORTANT:** tRPC routers use CustomTRPCError for centralized error capture. Do NOT use try-catch or captureError directly in routers.

#### Pattern 1: Database Query

```typescript
import { TRPCError } from '@trpc/server';
import { toCustomTRPCError } from 'fpp/server/api/custom-error';
import { createTRPCRouter, publicProcedure } from 'fpp/server/api/trpc';

export const exampleRouter = createTRPCRouter({
  getData: publicProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ ctx: { db }, input: { id } }) => {
      const data = await db.query.table.findFirst({
        where: eq(table.id, id),
      }).catch((error) => {
        throw toCustomTRPCError(error, 'Failed to query database', {
          component: 'exampleRouter',
          action: 'getData',
          extra: { id },
          severity: 'high',
        });
      });

      if (!data) {
        throw new TRPCError({
          code: 'NOT_FOUND',
          message: 'Data not found',
        });
      }

      return data;
    }),
});
```

#### Pattern 2: External API Fetch

```typescript
const response = await fetch(url, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data),
}).catch((error) => {
  throw toCustomTRPCError(error, 'Failed to fetch external API', {
    component: 'exampleRouter',
    action: 'getData',
    extra: { url },
    severity: 'high',
  });
});

if (!response.ok) {
  throw toCustomTRPCError(
    new Error(`API error: ${response.status} ${response.statusText}`),
    'External API returned error status',
    {
      component: 'exampleRouter',
      action: 'getData',
      extra: { url, status: response.status },
      severity: 'high',
    },
  );
}

return response.json();
```

#### Pattern 3: Promise.allSettled

```typescript
const promises = [
  db.insert(table1).values(data1),
  db.insert(table2).values(data2),
  db.update(table3).set(data3).where(eq(table3.id, id)),
];

const results = await Promise.allSettled(promises);
const failedResults = results.filter(r => r.status === 'rejected');

if (failedResults.length > 0) {
  throw toCustomTRPCError(
    failedResults[0].reason,
    'Failed to persist data',
    {
      component: 'exampleRouter',
      action: 'procedureName',
      extra: {
        failedCount: failedResults.length,
        totalCount: promises.length,
      },
      severity: 'high',
    },
  );
}
```

### Error Types

**Business Logic Errors (use standard TRPCError):**
```typescript
// NOT_FOUND, CONFLICT, BAD_REQUEST, UNAUTHORIZED, FORBIDDEN
if (!data) {
  throw new TRPCError({
    code: 'NOT_FOUND',
    message: 'Resource not found',
  });
}
```
These are NOT captured in Sentry (expected user-facing errors).

**System Errors (use CustomTRPCError via toCustomTRPCError):**
```typescript
// Database failures, external API errors, timeouts
await db.query().catch((error) => {
  throw toCustomTRPCError(error, 'Failed to query', {
    component: 'routerName',
    action: 'procedureName',
    extra: { context },
    severity: 'high',
  });
});
```
These ARE captured in Sentry (unexpected system failures).

### Error Severity Guidelines

Use these severity levels consistently:

- **critical**: App crash, data loss, security breach
- **high**: User action blocked (database error, API failure, auth failure) - DEFAULT
- **medium**: Degraded experience (non-critical feature failures)
- **low**: Informational (analytics tracking failed, geo lookup failed)

### Common Mistakes to Avoid

‚ùå **Don't:**
- Use try-catch in tRPC routers (creates double-capture)
- Use captureError directly in tRPC routers (use toCustomTRPCError)
- Wrap business logic errors with CustomTRPCError (use standard TRPCError)
- Forget to add .catch() to async operations

‚úÖ **Do:**
- Use .catch() with toCustomTRPCError for all database/fetch operations
- Use standard TRPCError for business logic errors
- Provide component, action, and extra context in metadata
- Use severity 'high' (default) for system errors

## Additional Resources
Use Context7 MCP as a reference for documentation:
- **Next.js 16**: https://nextjs.org/docs
- **React 19**: https://react.dev
- **tRPC v11**: https://trpc.io/docs
- **React Query v5**: https://tanstack.com/query/latest
- **Mantine v8**: https://mantine.dev
- **Drizzle ORM**: https://orm.drizzle.team
- **Elysia**: https://elysiajs.com

## Version Control

### Branch Strategy
- `master` - Main branch (production)
- Feature branches - Descriptive names e.g. `feat/JK-60-add-analytics`
- Small stuff and so on usually can go directly to `master`

### Commit Messages
Follow conventional commits sometimes there might be a JK ticket number but not always:
```plaintext
feat(JK-60): add new feature
fix(JK-60): resolve bug
docs(JK-60): update documentation
style(JK-60): formatting changes
refactor(JK-60): code restructuring
test(JK-60): add tests
chore: maintenance tasks
```

### Releases

Use the `/release-fpp` skill to create releases with AI-enhanced GitHub release notes:

```bash
/release-fpp [version]  # version: patch/minor/major (optional)
```

**Workflow:**
1. Pre-flight checks (branch, clean state)
2. Analyzes commits since last tag
3. Generates AI summary (title, highlights, description)
4. Runs `npm run release` (version selection)
5. Enhances GitHub release with AI summary

**Note:** CHANGELOG.md stays clean with conventional changelog only. AI content appears only in GitHub release notes.

See `.claude/skills/release-fpp/SKILL.md` for full documentation.

---

**Last Updated**: 2026-01-03
**For detailed architecture explanation**: See `ARCHITECTURE.md` and `openspec/config.yaml`
